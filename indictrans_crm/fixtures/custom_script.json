[
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Opportunity", 
  "modified": "2017-05-16 13:14:26.634995", 
  "name": "Opportunity-Client", 
  "script": "// Copyright (c) 2015, Frappe Technologies Pvt. Ltd. and Contributors\n// License: GNU General Public License v3. See license.txt\n\nfrappe.provide(\"erpnext.crm\");\n\ncur_frm.email_field = \"contact_email\";\nfrappe.ui.form.on(\"Opportunity\", {\n\tcustomer: function(frm) {\n\t\terpnext.utils.get_party_details(frm);\n\t},\n\n\tcustomer_address: function(frm, cdt, cdn) {\n\t\terpnext.utils.get_address_display(frm, 'customer_address', 'address_display', false);\n\t},\n\n\tcontact_person: erpnext.utils.get_contact_details,\n\n\tenquiry_from: function(frm) {\n\t\tfrm.toggle_reqd(\"lead\", frm.doc.enquiry_from===\"Lead\");\n\t\tfrm.toggle_reqd(\"customer\", frm.doc.enquiry_from===\"Customer\");\n\t\t\n\t},\n\tcustomer:function(frm){\n\t\tif(frm.doc.customer){\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"indictrans_crm.customisation.set_terriotory\",\n\t\t\t\targs: {\n\t\t\t\t\t\"customer\": frm.doc.customer\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(r.message) {\n\t\t\t\t\t\tconsole.log(r.message)\n\t\t\t\t\t\tcur_frm.set_value(\"terittory\",r.message)\n\t\t\t\t\t\tcur_frm.refresh_field(\"territory\")\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t},\n\trefresh: function(frm) {\n\t\tvar doc = frm.doc;\n\t\tfrm.events.enquiry_from(frm);\n\t\tif(doc.status!==\"Lost\") {\n\t\t\tif(doc.with_items){\n\t\t\t\tfrm.add_custom_button(__('Supplier Quotation'),\n\t\t\t\t\tfunction() {\n\t\t\t\t\t\tfrm.trigger(\"make_supplier_quotation\")\n\t\t\t\t\t}, __(\"Make\"));\n\t\t\t}\n\n\t\t\tfrm.add_custom_button(__('Quotation'),\n\t\t\t\tcur_frm.cscript.create_quotation, __(\"Make\"));\n\n\t\t\tfrm.page.set_inner_btn_group_as_primary(__(\"Make\"));\n\t\t\n\t\t\tif(doc.status!==\"Quotation\") {\n\t\t\t\tfrm.add_custom_button(__('Lost'),\n\t\t\t\t\tcur_frm.cscript['Declare Opportunity Lost']);\n\t\t\t}\n\t\t}\n\t},\n\n\tmake_supplier_quotation: function(frm) {\n\t\tfrappe.model.open_mapped_doc({\n\t\t\tmethod: \"erpnext.crm.doctype.opportunity.opportunity.make_supplier_quotation\",\n\t\t\tfrm: cur_frm\n\t\t})\n\t}\n})\n\n// TODO commonify this code\nerpnext.crm.Opportunity = frappe.ui.form.Controller.extend({\n\tonload: function() {\n\t\tif(!this.frm.doc.enquiry_from && this.frm.doc.customer)\n\t\t\tthis.frm.doc.enquiry_from = \"Customer\";\n\t\tif(!this.frm.doc.enquiry_from && this.frm.doc.lead)\n\t\t\tthis.frm.doc.enquiry_from = \"Lead\";\n\n\t\tif(!this.frm.doc.status)\n\t\t\tset_multiple(this.frm.doc.doctype, this.frm.doc.name, { status:'Open' });\n\t\tif(!this.frm.doc.company && frappe.defaults.get_user_default(\"Company\"))\n\t\t\tset_multiple(this.frm.doc.doctype, this.frm.doc.name, \n\t\t\t\t{ company:frappe.defaults.get_user_default(\"Company\") });\n\n\t\tthis.setup_queries();\n\t},\n\n\tsetup_queries: function() {\n\t\tvar me = this;\n\n\t\tif(this.frm.fields_dict.contact_by.df.options.match(/^User/)) {\n\t\t\tthis.frm.set_query(\"contact_by\", erpnext.queries.user);\n\t\t}\n\n\t\tthis.frm.set_query(\"customer_address\", function() {\n\t\t\tif(me.frm.doc.lead) return {filters: { lead: me.frm.doc.lead } };\n\t\t\telse if(me.frm.doc.customer) return {filters: { customer: me.frm.doc.customer } };\n\t\t});\n\n\t\tthis.frm.set_query(\"item_code\", \"items\", function() {\n\t\t\treturn {\n\t\t\t\tquery: \"erpnext.controllers.queries.item_query\",\n\t\t\t\tfilters: {'is_sales_item': 1}\n\t\t\t};\n\t\t});\n\n\t\t$.each([[\"lead\", \"lead\"],\n\t\t\t[\"customer\", \"customer\"],\n\t\t\t[\"contact_person\", \"customer_filter\"],\n\t\t\t[\"territory\", \"not_a_group_filter\"]], function(i, opts) {\n\t\t\t\tme.frm.set_query(opts[0], erpnext.queries[opts[1]]);\n\t\t\t});\n\t},\n\n\tcreate_quotation: function() {\n\t\tfrappe.model.open_mapped_doc({\n\t\t\tmethod: \"erpnext.crm.doctype.opportunity.opportunity.make_quotation\",\n\t\t\tfrm: cur_frm\n\t\t})\n\t}\n});\n\n$.extend(cur_frm.cscript, new erpnext.crm.Opportunity({frm: cur_frm}));\n\ncur_frm.cscript.refresh = function(doc, cdt, cdn) {\n\terpnext.toggle_naming_series();\n\n\tvar frm = cur_frm;\n\tif(frm.perm[0].write && doc.docstatus==0) {\n\t\tif(frm.doc.status===\"Open\") {\n\t\t\tfrm.add_custom_button(__(\"Close\"), function() {\n\t\t\t\tfrm.set_value(\"status\", \"Closed\");\n\t\t\t\tfrm.save();\n\t\t\t});\n\t\t} else {\n\t\t\tfrm.add_custom_button(__(\"Reopen\"), function() {\n\t\t\t\tfrm.set_value(\"status\", \"Open\");\n\t\t\t\tfrm.save();\n\t\t\t});\n\t\t}\n\t}\n}\n\ncur_frm.cscript.onload_post_render = function(doc, cdt, cdn) {\n\tif(doc.enquiry_from == 'Lead' && doc.lead)\n\t\tcur_frm.cscript.lead(doc, cdt, cdn);\n}\n\ncur_frm.cscript.item_code = function(doc, cdt, cdn) {\n\tvar d = locals[cdt][cdn];\n\tif (d.item_code) {\n\t\treturn frappe.call({\n\t\t\tmethod: \"erpnext.crm.doctype.opportunity.opportunity.get_item_details\",\n\t\t\targs: {\"item_code\":d.item_code},\n\t\t\tcallback: function(r, rt) {\n\t\t\t\tif(r.message) {\n\t\t\t\t\t$.each(r.message, function(k, v) {\n\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, k, v);\n\t\t\t\t\t});\n\t\t\t\trefresh_field('image_view', d.name, 'items');\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t}\n}\n\ncur_frm.cscript.lead = function(doc, cdt, cdn) {\n\tcur_frm.toggle_display(\"contact_info\", doc.customer || doc.lead);\n\terpnext.utils.map_current_doc({\n\t\tmethod: \"erpnext.crm.doctype.lead.lead.make_opportunity\",\n\t\tsource_name: cur_frm.doc.lead,\n\t\tfrm: cur_frm\n\t});\n}\n\ncur_frm.cscript['Declare Opportunity Lost'] = function() {\n\tvar dialog = new frappe.ui.Dialog({\n\t\ttitle: __(\"Set as Lost\"),\n\t\tfields: [\n\t\t\t{\"fieldtype\": \"Text\", \"label\": __(\"Reason for losing\"), \"fieldname\": \"reason\",\n\t\t\t\t\"reqd\": 1 },\n\t\t\t{\"fieldtype\": \"Button\", \"label\": __(\"Update\"), \"fieldname\": \"update\"},\n\t\t]\n\t});\n\n\tdialog.fields_dict.update.$input.click(function() {\n\t\targs = dialog.get_values();\n\t\tif(!args) return;\n\t\treturn cur_frm.call({\n\t\t\tdoc: cur_frm.doc,\n\t\t\tmethod: \"declare_enquiry_lost\",\n\t\t\targs: args.reason,\n\t\t\tcallback: function(r) {\n\t\t\t\tif(r.exc) {\n\t\t\t\t\tmsgprint(__(\"There were errors.\"));\n\t\t\t\t} else {\n\t\t\t\t\tdialog.hide();\n\t\t\t\t\tcur_frm.refresh();\n\t\t\t\t}\n\t\t\t},\n\t\t\tbtn: this\n\t\t})\n\t});\n\tdialog.show();\n}\n", 
  "script_type": "Client"
 }
]